<project name="project-include">

  <!-- figure out the absolute path to this build file -->
  <dirname property="etc.dir" file="${ant.file.project-include}"/>
  <import file="${etc.dir}/flex-include.xml"/>

  <!-- overridable properties -->
  <property name="flex.use-network" value="false"/>
  <property name="app.source-suffix" value="as"/>
  <property name="app.source-dir" value="."/>
  <property name="app.package-dir" value="."/>
  <property name="app.library-dir" value="."/>
  <property name="app.server-files" value="server-files.txt"/>
  <property name="thane.path" value="${etc.dir}/../libraries/thane/tamarin-central/dist/thane/avmthane"/>

  <!-- if the user specifies arg.source-extras, build a whole new argument       -->
  <!-- out of it. otherwise just use a dummy value (can't easily skip it, alas). -->
  <condition property="app.source-extras.arg"
             value="-compiler.source-path=${app.source-extras}"
             else="-externs=DummyValueIgnore">
    <isset property="app.source-extras"/>
  </condition>
  <condition property="app.lib-extras.arg"
             value="-library-path+=${app.lib-extras}"
             else="-externs=DummyValueIgnore">
    <isset property="app.lib-extras"/>
  </condition>

  <!-- explains things -->
  <target name="help">
    <echo>The following targets are available:</echo>
    <echo>  ant compile - builds your project</echo>
    <echo>  ant test - builds game projects and runs them in a test environment</echo>
    <echo>  ant -Dplayers=4 test - runs multiple test clients for multiplayer testing</echo>
    <echo>  ant clean - cleans out build resluts</echo>
  </target>

  <!-- builds our SWF file -->
  <target name="compile" depends="build,zip"/>

  <!-- builds our SWF file in debug mode -->
  <target name="debug">
    <property name="flex.debug-arg" value="-compiler.debug"/>
    <antcall target="compile"/>
  </target>

  <!-- handles the heavy lifting for compile/debug -->
  <target name="build" depends="prepare-flex">
    <property name="flex.debug-arg" value="-externs=DummyValueIgnore"/>
    <java jar="${flex.path}/lib/mxmlc.jar" fork="true" failonerror="true">
      <arg value="-load-config"/>
      <arg value="${etc.dir}/whirled-config.xml"/>
      <arg value="-library-path+=${build.root}/dist/lib"/>
      <arg value="-library-path+=${app.library-dir}"/>
      <arg value="${flex.debug-arg}"/>
      <arg value="-compiler.source-path=${app.source-dir}"/>
      <arg value="-use-network=${flex.use-network}"/>
      <arg value="-compiler.source-path=${build.root}/contrib/src/as"/>
      <arg value="${app.source-extras.arg}"/>
      <arg value="${app.lib-extras.arg}"/>
      <arg value="-file-specs"/>
      <arg value="${app.source-dir}/${app.package-dir}/${app.name}.${app.source-suffix}"/>
      <arg value="-output"/>
      <arg value="${app.name}.swf"/>
    </java>
  </target>

  <target name="check-has-server-code">
    <condition property="has-server-code"><and>
      <available file="${thane.path}"/>
      <available file="${app.server-files}"/>
    </and></condition>
  </target>

  <!-- Use asc to build the server-side code TODO: wire into main build -->
  <target name="build-server" if="has-server-code" depends="check-has-server-code">
    <path id="build-server-classes">
      <fileset dir="${build.root}/dist/lib">
        <include name="asc.jar"/>
        <include name="flexTasks.jar"/>
      </fileset>
    </path>
    <property name="sdk.src.dir" location="${build.root}/libraries/whirled/src/as"/>
    <echo>Building server</echo>
    <taskdef name="asc" classname="flex.ant.AscTask" classpathref="build-server-classes"/>
    <asc as3="true" strict="true" classpathref="build-server-classes" use="AS3">
      <import dir="${build.root}/dist/lib">
        <include name="tamarin-builtin*.abc"/>
        <include name="thane*.abc"/>
      </import>
      <in dir="${sdk.src.dir}"><includesfile name="${etc.dir}/asc-files-00.txt"/></in>
      <in dir="${sdk.src.dir}"><includesfile name="${etc.dir}/asc-files-01.txt"/></in>
      <in dir="${sdk.src.dir}"><includesfile name="${etc.dir}/asc-files-02.txt"/></in>
      <in dir="${app.source-dir}"><includesfile name="${app.server-files}"/></in>
      <filespec dir="${etc.dir}" includes="empty.as"/>
    </asc>
    <move overwrite="true" file="${etc.dir}/empty.abc" tofile="${app.name}.abc"/>
  </target>

  <!-- zip things up for remixables -->
  <target name="zip" if="app.data-dir">
    <zip destfile="${app.name}.zip" compress="false">
      <!-- Let _data.xml be in either the top-level or the data dir, even though
           we now prefer it to be in the data dir. -->
      <zipfileset dir="." includes="${app.name}.swf, _data.xml"/>
      <zipfileset dir="${app.data-dir}" includes="*" prefix=""/>
    </zip>
    <delete file="${app.name}.swf"/>
  </target>

  <target name="asdoc" description="Builds documentation in a 'docs' subdirectory.">
    <exec executable="${flex.path}/bin/asdoc" failonerror="true">
      <arg line="-library-path ${build.root}/dist"/>
      <arg line="-library-path ${build.root}/dist/lib"/>
      <arg line="-library-path ${app.library-dir}"/>
      <arg line="-library-path+=${app.lib-extras}"/>
      <arg line="-templates-path ${flex.path}/asdoc/templates"/>
      <arg line="-doc-sources ."/>
      <arg line="-output docs"/>
    </exec>
  </target>

  <!-- cleans out the compiled SWF -->
  <target name="clean">
    <delete>
       <fileset file="${app.name}.swf"/>
       <fileset file="${app.name}.zip"/> <!-- danger? -->
    </delete>
  </target>

  <!-- a target for building and running the game client -->
  <property name="players" value="1"/>
  <property name="remotePlayers" value="0"/>
  <target name="test" depends="compile,test-only"
    description="Recompiles your project and runs it within the test environment."/>

  <target name="test-debug" depends="debug,test-only"
    description="Recompiles your project (with debugging) and runs it within the test environment."/>

  <target name="test-only">
    <!-- No description. You should use "test" or "test-debug". -->

    <!-- make sure the build.properties file exists -->
    <fail>
      <condition><not><isset property="player.path"/></not></condition>
      Please copy the build.properties.dist file to build.properties in the
      ${build.root} directory and edit the build properties file to point to
      your standalone Flash player.
    </fail>

    <!-- if this appears to be a remixable project, the suffix is zip. -->
    <condition property="app.suffix" value="zip" else="swf">
      <isset property="app.data-dir"/>
    </condition>
    <property name="app.type" value="game"/> <!-- default to game if unset -->
    <antcall target="test-${app.type}"/>
  </target>

  <target name="test-avatar">
    <echoxml file="parameters.xml">
    <parameters>
      <param name="avatar" value="file://${basedir}${file.separator}${app.name}.${app.suffix}"/>
    </parameters>
    </echoxml>
    <!-- this is lame, but oh well. We copy the viewer to the current directory so that
         we can read the parameters out of the same directory on every platform. -->
    <copy file="${build.root}/lib/viewer.swf" todir="."/>
    <exec executable="${player.path}">
      <arg value="./viewer.swf"/>
    </exec>
    <!-- <delete file="./viewer.swf"/> -->
  </target>

  <target name="delete-abc" unless="has-server-code" depends="check-has-server-code">
    <delete file="${build.root}/dist/game.abc"/>
  </target>

  <target name="copy-abc" if="has-server-code" depends="check-has-server-code">
    <copy overwrite="true" file="${app.name}.abc" tofile="${build.root}/dist/game.abc"/>
  </target>

  <target name="test-game" depends="delete-abc,copy-abc">
    <copy file="${app.name}.swf" tofile="${build.root}/dist/game.swf"/>

    <!-- start the server which will start up the clients -->
    <java classname="com.whirled.server.WhirledTestServer" fork="true">
      <sysproperty key="whirled.root" value="${build.root}"/>
      <sysproperty key="players" value="${players}"/>
      <sysproperty key="remotePlayers" value="${remotePlayers}"/>
      <sysproperty key="party" value="${party}"/>
      <sysproperty key="flash.player" value="${player.path}"/>
      <sysproperty key="thane.path" value="${thane.path}"/>
      <classpath>
        <fileset dir="${build.root}/dist" includes="whirled-code.jar"/>
        <fileset dir="${build.root}/dist" includes="whirled-data.jar"/>
        <fileset dir="${build.root}/dist/lib" includes="*.jar"/>
      </classpath>
    </java>
  </target>

  <target name="test-furni">
    <!-- TODO: create a furni viewer that emulates the server environ and loads up the
      furni in two flashplayer instances. -->
    <echo>NOTE: furni projects do not currently have a test environment.</echo>
    <echoxml file="parameters.xml">
    <parameters>
      <param name="media" value="file://${basedir}${file.separator}${app.name}.${app.suffix}"/>
    </parameters>
    </echoxml>
    <!-- this is lame, but oh well. We copy the viewer to the current directory so that
         we can read the parameters out of the same directory on every platform. -->
    <copy file="${build.root}/lib/viewer.swf" todir="."/>
    <exec executable="${player.path}">
      <arg value="./viewer.swf"/>
    </exec>
    <!-- <delete file="./viewer.swf"/> -->
  </target>

  <target name="test-decor">
    <!-- TODO: create a decor viewer that emulates the server environ and loads up the
      decor in two flashplayer instances. -->
    <echo>NOTE: decor projects do not currently have a test environment.</echo>
    <echoxml file="parameters.xml">
    <parameters>
      <param name="media" value="file://${basedir}${file.separator}${app.name}.${app.suffix}"/>
    </parameters>
    </echoxml>
    <!-- this is lame, but oh well. We copy the viewer to the current directory so that
         we can read the parameters out of the same directory on every platform. -->
    <copy file="${build.root}/lib/viewer.swf" todir="."/>
    <exec executable="${player.path}">
      <arg value="./viewer.swf"/>
    </exec>
    <!-- <delete file="./viewer.swf"/> -->
  </target>

  <target name="test-toy">
    <!-- TODO: create a toy viewer that emulates the server environ and loads up the
      toy in two flashplayer instances. -->
    <echo>NOTE: toy projects do not currently have a test environment.</echo>
    <echoxml file="parameters.xml">
    <parameters>
      <param name="media" value="file://${basedir}${file.separator}${app.name}.${app.suffix}"/>
    </parameters>
    </echoxml>
    <!-- this is lame, but oh well. We copy the viewer to the current directory so that
         we can read the parameters out of the same directory on every platform. -->
    <copy file="${build.root}/lib/viewer.swf" todir="."/>
    <exec executable="${player.path}">
      <arg value="./viewer.swf"/>
    </exec>
    <!-- <delete file="./viewer.swf"/> -->
  </target>

  <target name="test-pet">
    <!-- TODO: create a pet viewer that emulates the server environ and loads up the
      pet in two flashplayer instances. -->
    <echo>NOTE: pet projects do not currently have a test environment.</echo>
    <echoxml file="parameters.xml">
    <parameters>
      <param name="media" value="file://${basedir}${file.separator}${app.name}.${app.suffix}"/>
    </parameters>
    </echoxml>
    <!-- this is lame, but oh well. We copy the viewer to the current directory so that
         we can read the parameters out of the same directory on every platform. -->
    <copy file="${build.root}/lib/viewer.swf" todir="."/>
    <exec executable="${player.path}">
      <arg value="./viewer.swf"/>
    </exec>
    <!-- <delete file="./viewer.swf"/> -->
  </target>
</project>
